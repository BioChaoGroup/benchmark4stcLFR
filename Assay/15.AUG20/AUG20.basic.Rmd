---
title: "AUG20 DATA ASSESSMENT"
author: "Chao"
date: "1/21/2020"
output: 
  html_notebook:
    code_fold: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(reshape2)
library(ggplot2)
library(plyr)
library(dplyr)
library(RColorBrewer)
library(configr)
```

# Background

Samples involved:

| ID | lane | barcode | Kindom | RCA | Location    |
| -- | ---- | ------- | -------| --- | ----------- |
| U1 | FF1  | 1,17    | Bac    | RCA | Urine       |
| S1 | FF1  | 3,4     | Bac    | RCA | Soil spot A |
| O1 | FF1  | 5,22    | Bac    | RCA | Soil spot B |
| M1 | FF1  | 7       | Bac    | RCA | Mock        |
| Z1 | FF1  | 8       | Bac    | RCA | ZYMO 8      |

Zymo mock strains:

| Species                  | Genomic DNA | 16S Only1 | 16S & 18S1 | Genome Copy2 | Cell Number3 |
| ------------------------ | ----------- | --------- | ---------- | ------------ | ------------ |
| Pseudomonas aeruginosa   | 12          | 4.2       | 3.6        | 6.1          | 6.1          | +
| Escherichia coli         | 12          | 10.1      | 8.9        | 8.5          | 8.5          | +
| Salmonella enterica      | 12          | 10.4      | 9.1        | 8.7          | 8.8          | +
| Lactobacillus fermentum  | 12          | 18.4      | 16.1       | 21.6         | 21.9         |
| Enterococcus faecalis    | 12          | 9.9       | 8.7        | 14.6         | 14.6         | +
| Staphylococcus aureus    | 12          | 15.5      | 13.6       | 15.2         | 15.3         | +
| Listeria monocytogenes   | 12          | 14.1      | 12.4       | 13.9         | 13.9         | +
| Bacillus subtilis        | 12          | 17.4      | 15.3       | 10.3         | 10.3         | +
| Saccharomyces cerevisiae | 2           | NA        | 9.3        | 0.57         | 0.29         |
| Cryptococcus neoformans  | 2           | NA        | 3.3        | 0.37         | 0.18         |

**stat on HPC**
```{bash, eval=False}


for i in SAM/??/mash/BI.msh.tsv;do 
  awk '{b=sprintf("%0.0f",$3/100)*100;print $2"\t"b}'  $i|sort|uniq -c|sort -nk2 -nk3 > ${i/mash/stat} &
done


#sum
for i in `ls SAM`;do 
 awk -v n=$i '{print n"\t"$0}' SAM/$i/stat/BI.msh.tsv;
done > STAT/BI.msh.tsv

```


**For the first time, grab data from HPC**
```{bash,eval=FALSE}
#get BB.stat
res=../../Results/AUG20/ORI
rsync -atvP --files-from=$res/tmp.file.lst ngb8:$remote/Results/AUG20/ORI/ $res/
```

```{bash}
res=../../Results/AUG20/ORI
ls $res/|grep FF
```

```{bash}
res=../../Results/AUG20/ORI
for i in `ls $res|grep FF`;do 
  awk -v i=$i '{print i"\t"$0}' $res/$i/clean/BB.stat;
done > $res/SUM.BB.stat


```

# load 

```{r}
metadata <- read.csv("../../Results/JAN20/metadata.csv")
```

```{r}
metadata.df <- (read.table("../../Results/JAN20/dataInfo.tsv",
                          col.names=c("SID","barcode","lane","tag","path")))[,1:4]

basic.ORI.tsv <- read.table("../../Results/AUG20/STAT/ORI.basic.log",header = T)
basic.SAM.S.tsv <- read.table("../../Results/AUG20/STAT/SAM.basic.single.log",header = T)
basic.SAM.R.tsv <- read.table("../../Results/AUG20/STAT/SAM.basic.RCA.log",header = T)
basic.SAM.N.tsv <- read.table("../../Results/AUG20/STAT/SAM.basic.NOR.log",header = T)

ORI.BB.stat <- read.table("../../Results/AUG20/STAT/ORI.BB.stat",
                         col.names = c("tag","count","rpb","cumsum"))
BB.stat <- ORI.BB.stat
SAM.BB.stat <- read.table("../../Results/AUG20/STAT/SAM.BB.stat",
                         col.names = c("tag","count","rpb","cumsum"))
BI.msh.tsv <- read.table("../../Results/AUG20/STAT/BI.msh.tsv",
                         col.names = c("SID","count","rpb","kmers"))
```


# Curate
```{r}
metadata.df$SAM <- substr(metadata.df$SID,1,1)
metadata.df$lane <- substr(metadata.df$SID,2,2)
metadata.df$RCA <- ifelse(metadata.df$lane%in%seq(1,6),T,F)
metadata.df$kingdom <- ifelse(metadata.df$lane%in%c(1,2,3,7,8,9),"B","F")

metadata$SAM <- substr(metadata$SID,1,1)
metadata$lane <- substr(metadata$SID,2,2)
metadata$RCA <- ifelse(metadata$lane%in%seq(1,6),T,F)
metadata$kingdom <- ifelse(metadata$lane%in%c(1,2,3,7,8,9),"B","F")

SAM.BB.reads <- ddply(SAM.BB.stat,"tag",summarise,BB.reads=sum(count*rpb))
```

```{r}
basic.ori.df2 <- merge(metadata.df,basic.ORI.tsv,by.x="tag",by.y=".ID")
rn <- colnames(basic.SAM.R.tsv)
basic.SAM.N.tsv$ASM.beads <- NA
basic.sam.df2 <- merge(unique(metadata.df[,c(1,3,5:7)]),
  rbind(basic.SAM.S.tsv[,rn],basic.SAM.R.tsv,basic.SAM.N.tsv),
  by.x="SID",by.y=".ID")
basic.sam.df2 <- merge(basic.sam.df2,SAM.BB.reads,by.x="SID",by.y="tag")

basic.sam.df2%>%filter(RCA==T&SAM%in%c("S","O"))
ddply(basic.sam.df2%>%filter(RCA==T&SAM%in%c("S","O")),c("kingdom"),summarise,count=sum(BB.reads))
```

```{r p1}
p1.1 <- ggplot(basic.ori.df2,aes(x=SID)) +
  geom_bar(aes(y=fastp.before_filtering.total_reads),position="stack",stat="identity",fill=NA,color="black") +
  geom_bar(aes(y=fastp.after_filtering.total_reads),position="stack",stat="identity",fill="grey50",alpha=.5) +
  ggtitle("Beofre/after filter reads number")
p1.1

ggplot(basic.ori.df2,aes(x=SID)) +
  geom_bar(aes(y=fastp.before_filtering.total_reads),position="stack",stat="identity",fill=NA,color="black") +
  geom_bar(aes(y=fastp.after_filtering.total_reads),position="stack",stat="identity",fill="grey50",alpha=.5) +
  ggtitle("Beofre/after filter reads number") + facet_grid(.~kingdom,scale="free")

rm.name <- c("fastp.before_filtering.read1_mean_length","fastp.before_filtering.read2_mean_length")
basic.ori.df3 <- melt(basic.ori.df2[,-which(colnames(basic.ori.df2)%in%rm.name)],
                      id.vars = colnames(basic.ori.df2)[1:7],
                      variable.name = "var",value.name = "val")
ggplot(basic.ori.df3,aes(x=kingdom,y=val)) + geom_boxplot() + coord_flip() +
  facet_wrap(~var,ncol=5,scale="free")
```

```{r p2}
selectSID <- c("Z1","Z2","Z3","M4","M5","M6",paste0(rep(c("S","O"),each=6),rep(seq(1,6),2)))
bacMockSID <- c("Z1","Z2","Z3")
p2.1 <- ggplot(basic.sam.df2%>%filter(SID%in%selectSID),aes(x=SID)) +
  geom_bar(aes(y=QC.reads/1e6),stat="identity",fill=NA,color="black") +
  geom_bar(aes(y=BB.reads/1e6),stat="identity",fill="grey50",color=NA) +
  geom_bar(aes(y=BB.singleton/1e6),stat="identity",fill="brown1",color=NA) +
  ylab("# reads/ Mb")
p2.1

bsd2.stat <- ddply(basic.sam.df2%>%filter(SID%in%selectSID),
   "RCA",summarise,QC.reads=mean(QC.reads),BB.reads=mean(BB.reads),BB.singleton=mean(BB.singleton),
   read.pct=mean(BB.reads)/mean(QC.reads),singleton.pct=mean(BB.singleton)/mean(QC.reads))
bsd2.stat
p2.2 <- ggplot(bsd2.stat,aes(x="mean")) +
  geom_bar(aes(y=QC.reads/1e6),stat="identity",fill=NA,color="black") +
  geom_bar(aes(y=BB.reads/1e6),stat="identity",fill="grey50",color=NA) +
  geom_bar(aes(y=BB.singleton/1e6),stat="identity",fill="brown1",color=NA,width=.85) +
  ylab("# reads/ Mb")
p2.2

basic.sam.df3 <- melt(basic.sam.df2,
   id.vars = colnames(basic.sam.df2)[1:5], variable.name = "var",value.name = "val")

ggplot(basic.sam.df2,aes(x=SID)) +
  geom_bar(aes(y=QC.reads),stat="identity",fill=NA,color="black") +
  geom_bar(aes(y=BB.reads),stat="identity",fill="grey50",color=NA) +
  geom_bar(aes(y=BB.singleton),stat="identity",fill="brown1",color=NA)


BB.stat <- melt(ddply(basic.sam.df2,"SID",summarise,BB.detect=BB.reads/QC.reads,BB.sing=BB.singleton/BB.reads),
                id.vars = "SID",variable.name = "var",value.name = "pecentage")
ddply(BB.stat,"var",summarise,pct=mean(pecentage))
ddply(basic.sam.df2,c("kingdom","SID"),summarise,ASM.pct=ASM.beads/BB.beads)
```

```{r}
zymo.RCA.df <- ddply(basic.sam.df2%>%filter(SID%in%c("Z1","Z2","Z3")),"kingdom",summarise,
                     QC.reads=mean(QC.reads),BB.reads=mean(BB.reads),BB.singleton=mean(BB.singleton))
zymo.RCA.df.pct <- zymo.RCA.df[,2:4]/zymo.RCA.df$QC.reads
ggplot(zymo.RCA.df,aes(x="Zymo")) +
  geom_bar(aes(y=QC.reads/1e6),stat="identity",fill=NA,color="black") +
  geom_bar(aes(y=BB.reads/1e6),stat="identity",fill="lightseagreen",color=NA) +
  geom_bar(aes(y=BB.singleton/1e6),stat="identity",fill="grey50",color=NA) +
  ylab("# reads/ Mb")
```

```{r}
ggplot(basic.sam.df2,aes(x=SID)) +
  geom_bar(aes(y=ASM.beads),stat="identity",fill=NA,color="black")
  #geom_bar(aes(y=ASM.clips),stat="identity",fill="grey50",color=NA)

ggplot(basic.sam.df2%>%filter(lane%in%seq(1,6)),aes(x=SID)) +
  geom_bar(aes(y=BB.beads),stat="identity",fill=NA,color="black") +
  geom_bar(aes(y=ASM.beads),stat="identity",fill="grey50",color=NA)
  #geom_bar(aes(y=ASM.clips),stat="identity",fill="brown1",color=NA)

ggplot(ddply(basic.sam.df2%>%filter(lane%in%seq(1,6)),c("kingdom","SID"),summarise,pct=ASM.beads/BB.beads),
       aes(x=kingdom,y=pct)) +geom_boxplot()
```


```{r }
BB.mdat <- merge(metadata.df,ORI.BB.stat,by="tag")
BI.lst$BI <- sprintf("BI%08d",BI.lst$BI0)
#mdat.ctg <- merge(merge(BI.lst,contig.tsv,by="BI"),B.kmer[,-2],by="BB")
mdat.ctg <- merge(merge(BI.lst,contig.tsv,by="BI"),BI.freq.tsv[,-c(2:3)],by="BB")
mdat.ctg$cov0 <- round(mdat.ctg$cov/2-0.49,0) * 2
mdat.ctg$len0 <- round(mdat.ctg$len/500-0.49,0) * 500
mdat.ctg$kCov <- mdat.ctg$rpb*140/mdat.ctg$kmers
mdat.ctg$kCov0 <- round(mdat.ctg$kCov,0)
mdat.ctg$h12 <- round(mdat.ctg$hash1/mdat.ctg$hash2,0)
mdat.ctg$rpbin <- round(mdat.ctg$rpb/mdat.ctg$bins,0)
```
```{r p4}
ggplot(mdat.ctg%>%filter(cov0<50),aes(x=factor(cov0),y=len,fill=factor(flag))) + geom_boxplot()
ggplot(mdat.ctg,aes(x=factor(len0),y=kCov,fill=factor(flag))) + geom_boxplot()
ggplot(mdat.ctg,aes(x=factor(kCov0),y=len,fill=factor(flag))) + geom_boxplot()
ggplot(mdat.ctg%>%filter(h12<20),aes(x=factor(h12),y=len,fill=factor(flag))) + geom_boxplot()
ggplot(mdat.ctg%>%filter(rpbin<100),aes(x=factor(rpbin),y=len,fill=factor(flag))) + geom_boxplot()
ggplot(mdat.ctg%>%filter(bins<49),aes(x=factor(bins),y=len,fill=factor(flag))) + geom_boxplot()
```

#BB.stat
```{r bb}
# Get unbarcoded reads number
basic.sam.df2$UB.reads <- basic.sam.df2$QC.reads - basic.sam.df2$BB.reads
sam.BB0.dat <- merge(metadata,basic.sam.df2[,c("SID","UB.reads","UB.reads")],by="SID")
colnames(sam.BB0.dat)[8:9] <- c("count","rpb")
sam.BB0.dat$rpb <- 0
sam.BB0.dat$cumsum <- NA
#
sam.BB.mdat <- rbind(sam.BB0.dat,merge(metadata,SAM.BB.stat,by.x="SID",by.y="tag"))
sam.BB.mdat$reads <- ifelse(sam.BB.mdat$rpb<2,sam.BB.mdat$count,sam.BB.mdat$count*sam.BB.mdat$rpb)
#
p5.1 <- ggplot(sam.BB.mdat%>%filter(SID%in%selectSID),aes(x=rpb,y=count,color=SAM,linetype=kingdom,group=SID)) + geom_line(size=1,alpha=.5) + 
  scale_y_log10() + scale_x_log10() + annotation_logticks() +
  xlab("reads/bead") + ylab("# Beads")
p5.1

p5.2 <- ggplot(sam.BB.mdat%>%filter(SID%in%selectSID&rpb!=0),aes(x=rpb,y=reads,color=SAM,linetype=kingdom,group=SID)) + geom_line(size=1,alpha=.5) + 
  scale_x_log10() +annotation_logticks(sides = "b") +
  xlab("reads/bead") + ylab("# reads") + theme_bw()
p5.2


```

accumulated counts
```{r}
revOrder <- function(d){
  d <- d[order(d$rpb,decreasing=T),]
  d$cumRd <- cumsum(d$reads)
  return(d)
}

sam.BB.mdat2 <- ddply(sam.BB.mdat,c("SID"),revOrder)
p5.3 <- ggplot(sam.BB.mdat2%>%filter(SID%in%bacMockSID&rpb>0),aes(x=rpb,y=cumsum,color=SID,group=SID)) +
  geom_line(size=1,alpha=.5) + 
  geom_point(data=sam.BB.mdat%>%filter(SID%in%bacMockSID&rpb>0&rpb<11),alpha=.5) +
  scale_y_log10() + scale_x_log10() + annotation_logticks() +
  xlab("reads per barcode") + ylab("count of barcodes")
p5.3
p5.4 <- ggplot(sam.BB.mdat2%>%filter(SID%in%bacMockSID&rpb>0),aes(x=rpb,y=cumRd,color=SID,group=SID)) +
  geom_line(size=1,alpha=.5) + 
  geom_point(data=sam.BB.mdat2%>%filter(SID%in%bacMockSID&rpb>0&rpb<11),alpha=.5) +
  scale_y_log10() + scale_x_log10() + annotation_logticks() +
  xlab("reads per barcode") + ylab("count of barcodes")
p5.4
```


**kmers**
```{r p6}
BI.msh.df <- merge(metadata,BI.msh.tsv,by="SID")
quanFun <- function(d,x){
  if(nrow(d)>1){
    var <- d[,which(colnames(d)==x)]
    d <- d[order(var),]
    n=sum(d$count)
    d$cumsum <- cumsum(d$count)
    i05 <- which(d$cumsum>n/40)[1] -1 
    i25 <- which(d$cumsum>n/4)[1] -1 
    i50 <- which(d$cumsum>n/2)[1] -1
    i75 <- which(d$cumsum>n*3/4)[1] -1 
    i95 <- which(d$cumsum>n*39/40)[1] -1 
    res <- d[1,]
    if(i05==0){i05=1}
    if(i25==0){i25=1}
    if(i50==0){i50=1}
    if(i75==0){i75=1}
    if(i95==0){i95=1}
    res$kmer.min <- var[i05]
    res$kmer.q25 <- var[i25]
    res$kmer.q50 <- var[i50]
    res$kmer.q75 <- var[i75]
    res$kmer.max <- var[i95]
    return(res)
  }
}

BI.msh.stat <- ddply(BI.msh.df%>%filter(SID%in%selectSID),colnames(BI.msh.df)[-6],summarise,count=sum(count))
BI.msh.stat$rpbs <- ifelse(BI.msh.stat$rpb<100,round(BI.msh.stat$rpb/5,0)*5,ifelse(
  BI.msh.stat$rpb<1000,round(BI.msh.stat$rpb/50,0)*50,">999"))
BI.msh.stat.sam <- ddply(BI.msh.stat,c("RCA","kindom","rpbs","kmers"),summarise,count=sum(count))
BI.msh.stat.sam.qt <- ddply(BI.msh.stat.sam,c("RCA","kindom","rpbs"),quanFun,"kmers")
BI.msh.stat.sam.qt$rpbs <- factor(BI.msh.stat.sam.qt$rpbs,levels=c(seq(1,999),">999"))
p6.1 <- ggplot(BI.msh.stat.sam.qt%>%filter(rpbs!=">999"),aes(x=rpbs,y=kmers,fill=kindom)) + 
  geom_boxplot(aes(ymin = kmer.min, lower = kmer.q25, middle = kmer.q50, upper = kmer.q75, ymax = kmer.max),
   stat = "identity") + theme(axis.text.x = element_text(angle = -90))
p6.1

BI.msh.stat$cpk <- round(BI.msh.stat$rpb*170/BI.msh.stat$kmers,0)
BI.msh.stat.sam2 <- ddply(BI.msh.stat,c("RCA","kindom","rpbs","cpk"),summarise,count=sum(count))
BI.msh.stat.sam2.qt <- ddply(BI.msh.stat.sam2,c("RCA","kindom","rpbs"),quanFun,"cpk")
BI.msh.stat.sam2.qt$rpbs <- factor(BI.msh.stat.sam.qt$rpbs,levels=c(seq(1,999),">999"))
p6.2 <- ggplot(BI.msh.stat.sam2.qt%>%filter(rpbs!=">999"),aes(x=rpbs,y=cpk,fill=kindom)) + 
  geom_boxplot(aes(ymin = kmer.min, lower = kmer.q25, middle = kmer.q50, upper = kmer.q75, ymax = kmer.max),
   stat = "identity") + theme(axis.text.x = element_text(angle = -90))
p6.2
```

```{r}
BI.num <- as.data.frame(table(mdat.ctg$BI))
colnames(BI.num) <- c("BI","member")
mdat.ctg3 <- merge(mdat.ctg,BI.num,by="BI")
mdat.ctg3$weight <- 1/mdat.ctg3$member
mdat.ctg3$member[which(mdat.ctg3$member>3)] <- "4&more"
mdat.ctg3$cov0 <- round(mdat.ctg3$cov,0)
mdat.ctg3$kCov0 <- round(mdat.ctg3$kCov,0)

ddply(mdat.ctg3,"member",summarise,num=sum(weight))

ggplot(mdat.ctg3%>%filter(cov0<30),aes(x=factor(cov0),y=len,fill=factor(flag))) + geom_boxplot() + 
  facet_grid(member~.)

```

```{r}
mdat.ctg3$kmer0 <- round(mdat.ctg3$kmers/100,0)*100
ggplot(mdat.ctg3%>%filter(kmers<3999),aes(x=factor(kmer0),y=len,fill=factor(flag))) + geom_boxplot() + 
  facet_grid(member~.)

mdat.ctg3$rpb0 <- round(mdat.ctg3$rpb/10,0)*10
ggplot(mdat.ctg3%>%filter(rpb<299),aes(x=factor(rpb0),y=len,fill=factor(flag))) + geom_boxplot() + 
  facet_grid(member~.)
```

结合clip比对信息：
```{r}
cmdat <- merge(merge(mdat.ctg[,-c(9,11,13)],clip2zymo[,c(1,2,5:7,8:12)],by=c("BI","id")),
               clip2zymo.region[,c("BI","id","region")],by=c("BI","id"))
cmdat$pct <- cmdat$match/cmdat$len
cmdat$len100 <- round(cmdat$len/100,0)*100
```
集合barrnap预测信息：
```{r}
rnahead.stat$rnaLen <- rnahead.stat$end-rnahead.stat$start+1
rnahead.stat$rnaPct <- rnahead.stat$rnaLen/rnahead.stat$len

cmdat <- merge(cmdat,rnahead.stat[,c(1,2,6:8)],by=c("BI","id"),all.x=T)
cmdat$rnaPct[which(is.na(cmdat$unit))] <- 0
levels(cmdat$unit) <- c("16S","23S","5S","mis")
cmdat$unit[which(is.na(cmdat$unit))] <- "mis"
```

```{r}
ggplot(cmdat,aes(x=pct,fill=factor(len100))) + geom_histogram() + scale_x_continuous(breaks = seq(0,1,0.2))
```

根据比对coverage来判断


```{r}
ggplot(cmdat%>%filter(pct<0.9),aes(x=len)) + geom_histogram()

```

```{r}
hybFun <- function(d){
  rN <- length(unique(d$species))
  res <- d[1,c("BI"),F]
  res$Rpb <- rN
  return(res)
}

cmdat$species <- sapply(strsplit(as.character(cmdat$ref),".",fixed = T),function(x) return(x[[1]]))
hybStat <- ddply(cmdat,"BI",hybFun)
hybStat$hyb <- ifelse(hybStat$Rpb>1,T,F)
cmstat <- merge(cmdat,hybStat,by="BI")
cmstat$kCov0 <- round(cmstat$rpb*140/cmstat$kmers,0)
cmstat$rpb0 <- round(cmstat$rpb/10,0) * 10
cmstat$kmers00 <- round(cmstat$kmers/100,0) * 100
cmstat$regUnit <- substr(cmstat$region,1,3)

ggplot(cmstat,aes(x=species,fill=factor(Rpb))) + geom_bar(stat="count") + theme(axis.text.x = element_text(angle=90,vjust=0))
ggplot(cmstat,aes(x=species,fill=factor(Rpb))) + geom_bar(stat="count",position="fill") + theme(axis.text.x = element_text(angle=90,vjust=0))
ggplot(cmstat,aes(x=unit,fill=factor(Rpb))) + geom_bar(stat="count") + theme(axis.text.x = element_text(angle=90,vjust=0))
ggplot(cmstat,aes(x=unit,fill=factor(Rpb))) + geom_bar(stat="count",position="fill") + theme(axis.text.x = element_text(angle=90,vjust=0))
ggplot(cmstat%>%filter(rpb0<300),aes(x=factor(rpb0),fill=factor(Rpb))) + geom_bar(stat="count",position="fill") + theme(axis.text.x = element_text(angle=90,vjust=0))

ggplot(cmstat,aes(x=fLen,color=regUnit,linetype=hyb)) + geom_density(size=1,alpha=.7) + facet_grid(regUnit~.,scale="free_y")
ggplot(cmstat,aes(x=fLen,color=unit,linetype=hyb)) + geom_density(size=1,alpha=.7) + facet_grid(unit~.,scale="free_y")
ggplot(cmstat,aes(x=rnaPct,color=unit,linetype=hyb)) + geom_density(size=1,alpha=.7) + facet_grid(unit~.,scale="free_y")
ggplot(cmstat,aes(x=pct,color=unit,linetype=hyb)) + geom_density(size=1,alpha=.7) + facet_grid(unit~.,scale="free_y") + scale_x_continuous(breaks=seq(0,1,.2))
ggplot(cmstat,aes(x=pct,color=unit,linetype=hyb)) + geom_density(size=1,alpha=.7) + facet_grid(unit~.,scale="free_y") + scale_x_continuous(breaks=seq(0,1,.2))


ggplot(cmstat,aes(x=kCov0,fill=hyb)) + geom_bar(stat="count",position="stack")
ggplot(cmstat,aes(x=kCov0,fill=hyb)) + geom_bar(stat="count",position="fill")
ggplot(cmstat%>%filter(cov<30),aes(x=cov0,fill=hyb)) + geom_bar(stat="count",position="stack")
ggplot(cmstat%>%filter(cov<30),aes(x=cov0,fill=hyb)) + geom_bar(stat="count",position="fill")

ggplot(cmstat,aes(x=factor(rpb0),fill=hyb)) + geom_bar(stat="count",position="fill") + 
  theme(axis.text.x = element_text(angle=90,vjust=0))

```

taxonomy percentage:
```{r}
zymo.copy.num <- data.frame(species=c("Pseudomonas_aeruginosa","Escherichia_coli","Salmonella_enterica","Lactobacillus_fermentum",
  "Enterococcus_faecalis","Staphylococcus_aureus","Listeria_monocytogenes","Bacillus_subtilis","Saccharomyces_cerevisiae","Cryptococcus_neoformans"),
  TC16S18S=c(3.6,8.9,9.1,16.1,8.7,13.6,12.4,15.3,9.3,3.3),copyNum=c(4,7,7,5,4,6,6,10,109,60))

cmstat$species <- as.factor(cmstat$species)
levels(cmstat$species) <- c(NA,"Bacillus_subtilis","Cryptococcus_neoformans","Enterococcus_faecalis","Escherichia_coli","Escherichia_coli",
                            "Lactobacillus_fermentum","Listeria_monocytogenes","Pseudomonas_aeruginosa","Saccharomyces_cerevisiae",
                            "Salmonella_enterica","Staphylococcus_aureus")
ggplot(zymo.copy.num,aes(x="zymo",y=TC16S18S,fill=species)) + geom_bar(stat="identity",position="fill") + ylab("16S & 18S")
ggplot(cmstat%>%filter(rpb<300),aes(x=factor(rpb0),fill=species)) + geom_bar(stat="count",position="fill") + 
  theme(axis.text.x = element_text(angle=90,vjust=0))


ggplot(zymo.copy.num%>%filter(!species%in%c("Saccharomyces_cerevisiae","Cryptococcus_neoformans")),
       aes(x="zymo",y=TC16S18S,fill=species)) + geom_bar(stat="identity",position="fill") + ylab("16S & 18S")
ggplot(cmstat%>%filter(rpb<300&!species%in%c("Saccharomyces_cerevisiae","Cryptococcus_neoformans")),aes(x=factor(rpb0),fill=species)) +
  geom_bar(stat="count",position="fill") + 
  theme(axis.text.x = element_text(angle=90,vjust=0))
ggplot(cmstat%>%filter(rpb<300&!species%in%c("Saccharomyces_cerevisiae","Cryptococcus_neoformans")),aes(x=factor(rpb0))) + 
  geom_bar(stat="count") + theme(axis.text.x = element_text(angle=90,vjust=0))

ggplot(cmstat%>%filter(unit!="5S"&rpb<300&!species%in%c("Saccharomyces_cerevisiae","Cryptococcus_neoformans")),aes(x=factor(rpb0),fill=species)) +
  geom_bar(stat="count",position="fill") + theme(axis.text.x = element_text(angle=90,vjust=0)) + facet_grid(unit~.)

ggplot(cmstat%>%filter(unit!="5S"&!species%in%c("Saccharomyces_cerevisiae","Cryptococcus_neoformans")),aes(x="all",fill=species)) +
  geom_bar(stat="count",position="fill") + theme(axis.text.x = element_text(angle=90,vjust=0)) + facet_grid(unit~.)

```


```{r}
cmstat.clean <- cmstat%>%filter(ref2!="hybridize")
cmstat.clean$kCov0 <- round(cmstat.clean$rpb*140/cmstat.clean$kmers,0)
cmstat.clean$kmers0 <- round(cmstat.clean$kmers/100,0) * 100
cmstat.clean$rpb0 <- round(cmstat.clean$rpb/10,0) * 10

ggplot(cmstat.clean%>%filter(kCov0<20),aes(x=factor(kCov0),fill=factor(ref2))) + geom_bar(stat="count")
ggplot(cmstat.clean%>%filter(kCov0<20),aes(x=factor(kCov0),fill=factor(ref2))) + geom_bar(stat="count",position="fill")
ggplot(cmstat.clean%>%filter(kmers<3000),aes(x=factor(kmers0),fill=factor(ref2))) + geom_bar(stat="count",position="fill")
ggplot(cmstat.clean%>%filter(rpb<300),aes(x=factor(rpb0),fill=factor(ref2))) + geom_bar(stat="count")
ggplot(cmstat.clean%>%filter(rpb<300),aes(x=factor(rpb0),fill=factor(ref2))) + geom_bar(stat="count",position="fill")

```

```{r}
cmdat2 <- cmdat
cmdat2$kCov0 <- round(cmdat2$rpb*140/cmdat2$kmers,0)
cmdat2$rpb0 <- round(cmdat2$rpb/10,0) * 10
cmdat2$len00 <- round(cmdat2$len/100,0) * 100
cmdat2$kmers00 <- round(cmdat2$kmers/100,0) * 100
cmdat2$kmerLen <- substr(cmdat2$id,1,4)

ggplot(cmdat2%>%filter(kCov0<20),aes(x=factor(kCov0),fill=factor(ref2))) + geom_bar(stat="count",position="fill")
ggplot(cmdat2%>%filter(rpb<300),aes(x=factor(rpb0),fill=factor(ref2))) + geom_bar(stat="count",position="fill")
ggplot(cmdat2%>%filter(rpb<300),aes(x=factor(ref2),fill=factor(rpb0))) + geom_bar(stat="count",position="fill")
ggplot(cmdat2,aes(x=factor(len00),fill=factor(ref2))) + geom_bar(stat="count")
ggplot(cmdat2,aes(x=factor(len00),fill=factor(ref2))) + geom_bar(stat="count",position="fill")

ggplot(cmdat2,aes(x=factor(len00),y=pct)) + geom_boxplot()
ggplot(cmdat2,aes(x=factor(len00),y=pct,fill=factor(flag))) + geom_boxplot() + scale_y_continuous(breaks=seq(0,1,0.2))
ggplot(cmdat2,aes(x=factor(cov0),y=pct,fill=factor(flag))) + geom_boxplot() + scale_y_continuous(breaks=seq(0,1,0.2))

```

```{r}
ggplot(cmdat2%>%filter(rpb<300),aes(x=factor(rpb0),fill=factor(ref2))) + geom_bar(stat="count",position="fill")

```


模型
```{r}
Exp.rpb <- sum(BB.stat$rpb*BB.stat$count)/sum(BB.stat$count)
Exp.rpb0 <- round(Exp.rpb,0)

BB.stat$prob <- BB.stat$count/(1.2*sum(BB.stat$count))
mock.dat <- data.frame(rpb=seq(0,49),
                       pois=(dpois(seq(0,49),1)+dpois(seq(0,49),2)+dpois(seq(0,49),3))/3,
                       norm=dnorm(seq(0,49),mean=5,sd=15))
mock.dat$p2 <- mock.dat$pois*0.8+mock.dat$norm*0.2
mock.dat <- merge(mock.dat,BB.stat[,c(2,4)],by="rpb",all.x=T)
mmock <- melt(mock.dat,id.vars = "rpb",variable.name = "method",value.name = "p")
ggplot(mmock,aes(x=rpb,y=p,color=method)) + geom_line() + geom_point()
```

```{r}
sdat.ctg <- ddply(mdat.ctg,c("BI","rpb","flag"),summarise,len=sum(len))
sdat.ctg$len0 <- round(sdat.ctg$len/500-0.49,0) * 500

sdat.ctg2 <- ddply(sdat.ctg,c("rpb","flag","len0"),summarise,count=length(BI))
sdat.ctg2 <- ddply(sdat.ctg2,c("flag","len0"),transform,frac=count/sum(count))

ggplot(sdat.ctg2%>%filter(len0>499&len0<2000),aes(x=rpb,y=frac,color=factor(len0))) + geom_line() + facet_grid(flag~.,scale="free") + xlim(0,200)
```

```{r}
ggplot(B.kmer,aes(x=kmers)) + geom_histogram() + scale_x_log10() + annotation_logticks(sides="b")

B.kmer2 <- B.kmer
B.kmer2$rpbL <- round(B.kmer2$rpb/10-0.49,0) *10
B.kmer2$rpbL[which(B.kmer2$rpbL>=150)] <- ">=150"
B.kmer2$rpbL <- factor(B.kmer2$rpbL,levels=c(seq(0,140,10),">=150"))
B.kmer2$kL <- round(B.kmer2$kmers/100-0.49,0) *100
B.kmer2$kL[which(B.kmer2$kL>=3000)] <- 3000
B.kmer2$kL[which(B.kmer2$kL<1000)] <- 900
B.kmer2$kL <- factor(B.kmer2$kL,levels=c(seq(900,3000,100)))

ggplot(B.kmer2,aes(x=rpb,fill=factor(kL))) + geom_histogram(position="stack") +
  scale_x_log10() + annotation_logticks(sides="b")

ggplot(B.kmer2,aes(x=rpb,fill=factor(kL))) + geom_histogram(position="fill") +
  scale_x_log10() + annotation_logticks(sides="b")
```

```{r}
ggplot(B.kmer2,aes(x=factor(rpbL),y=kmers)) + geom_boxplot() + 
  scale_y_continuous(breaks=seq(0,1e4,2000),limits = c(0,1e4))
```

```{r}
B.kmer2$kCov <- B.kmer2$rpb*160/B.kmer2$kmers

ggplot(B.kmer2,aes(x=factor(rpbL),y=kCov)) + geom_boxplot() + 
  scale_y_continuous(breaks=seq(0,30,2))

ggplot(B.kmer2,aes(x=kmers,y=kCov)) + 
  geom_density_2d()
```

```{r}
ggplot(B.kmer2,aes(x=factor(kL),y=kCov)) + geom_boxplot() + 
  scale_y_continuous(breaks=seq(0,10,2),limits = c(0,10))
```

```{r}
B.kmer2S <- ddply(B.kmer2,c("kL","rpbL"),summarise,count=length(BB))
ggplot(B.kmer2S,aes(x=rpbL,y=kL,fill=log10(count))) + 
  geom_tile() + scale_fill_gradientn(colors=rev(brewer.pal(11,"Spectral")))
```

```{r}
ggplot(mdat2,aes(x=slen,fill=factor(num))) + geom_histogram(position="stack")
```

```{r}
ggplot(mdat2%>%filter(num%in%seq(1,2)),aes(x=rpb.x,y=kmers,color=factor(num))) + 
  geom_density_2d() + 
  scale_y_continuous(breaks=seq(0,8000,1000)) +
  scale_x_continuous(breaks=seq(100,500,20))
```

```{r}
mdat2$slen <- mdat2$mlen*mdat2$num
ggplot(mdat2%>%filter(num%in%seq(1,2)),aes(x=kmers,y=slen,color=factor(num))) + 
  geom_density_2d()
```

```{r}
mdat2$kCov <- mdat2$rpb.x*160/mdat2$kmers
ggplot(mdat2%>%filter(num%in%seq(1,3)),aes(x=kmers,y=kCov,color=factor(num))) + 
  geom_density_2d() + scale_y_continuous(breaks=seq(4,12))
```

1000 < kmers < 3000 & kCov > 6


```{r}
mdat3 <- B.kmer2%>%filter(kCov>6&kmers>1000)

ggplot(mdat3,aes(x=rpb,y=kmers)) + geom_density_2d()
```
#Beads counts
```{r}
BB.info <- read.csv("../../Results/AUG20/STAT/statinfo.csv")
ggplot(BB.info,aes(x=ID,y=isoBeads)) + geom_bar(stat="identity")
```

#barnnap RSU (LSU & SSU) information
```{bash}
#test
metabbq stat RSU -l SAM/S1/VSEARCH/barrnap.LSU.fasta -s SAM/S1/VSEARCH/barrnap.SSU.fasta -o SAM/S1/stat/barrnap.RSU.stat
# batch beta
metabbq smk -j -npk SAM/{{U,O,S,M,Z}{1,2,3},{S,O,M,Y}{4,5,6}}/stat/barrnap.RSU.stat

mkln ../../Results/AUG20/STAT

for i in {{U,O,S,M,Z}{1,2,3},{S,O,M,Y}{4,5,6}};do 
  awk -v n=$i '{print n"\t"$0}' SAM/$i/stat/barrnap.RSU.stat;
done > STAT/barrnap.RSU.stat

for i in {S,O,M,Y}{4,5,6};do 
  awk -v n=$i '{print n"\t"$0}' SAM/$i/stat/barrnap.bac.RUS.stat;
done > STAT/barrnap.bac.RSU.stat
```

**curate**
```{r}
t.stat <- read.table("../../Results/AUG20/STAT/barrnap.RSU.stat",
   col.names=c("SID","BI","No","unit","kmer","flag","multi","aLen","cType","Ad","cLen","sPos","ePos","dir"))
t.abn.stat <- read.table("../../Results/AUG20/STAT/barrnap.bac.RSU.stat",
   col.names=c("SID","BI","No","unit","kmer","flag","multi","aLen","cType","Ad","cLen","sPos","ePos","dir"))

if(exists("../../Results/AUG20/STAT/BU.RData")){
  load("../../Results/AUG20/STAT/BU.RData")
}{
  library(doSNOW)
  sFun <- function(d){
    res <- ddply(d,"BI",summarise,
                 aLen=aLen[1],cLen=cLen[1],bLen=sum(ePos-sPos+1),
                 BU=paste0(sort(unique(unit)),collapse = "&"))
    return(res)
  }
  cl <- makeCluster(6, type = "SOCK")
  registerDoSNOW(cl)
  BU.stat <- ddply(t.stat,c("SID"),sFun,.parallel=T)
  BU.abn <- ddply(t.abn.stat,c("SID"),sFun,.parallel=T)
  stopCluster(cl)
  save(BU.stat,BU.abn,file="./../Results/AUG20/STAT/BU.RData")
}

```

**stat**
```{r}
BU.count <- ddply(BU.stat,c("SID","BU"),summarise,count=length(BI))

ggplot(BU.stat,aes(x=SID,fill=BU)) +geom_bar()
ggplot(BU.stat,aes(x=SID,fill=BU)) +geom_bar(position="fill")
```

比较对真菌样本进行细菌RNA预测的结果：
```{r}
BU.abnct <- ddply(BU.abn,c("SID","BU"),summarise,count=length(BI))

BU.comb <- rbind(cbind(predict="RIGHT",t.stat), cbind(predict="WRONG",t.abn.stat))
BU.ABN <- rbind(cbind(predict="RIGHT",BU.stat), cbind(predict="WRONG",BU.abn))
BU.ABNCT <- rbind(cbind(predict="RIGHT",BU.count), cbind(predict="WRONG",BU.abnct))

ggplot(BU.ABN,aes(x=SID,fill=BU)) +geom_bar() + facet_grid(.~predict,space="free",scale="free")

```


```{r}
ggplot(t.stat,aes(x=SID,fill=cType)) +geom_bar()
ggplot(t.stat,aes(x=SID,fill=cType)) +geom_bar(position="fill")

```

```{r}
BU.stat$SAM <- substr(BU.stat$SID,1,1)
BU.stat$LAN <- substr(BU.stat$SID,2,2)
BU.stat$KDM <- ifelse(BU.stat$LAN%in%c(1,2,3),"BAC","FUG")
BU.stat$rep <- as.character(as.numeric(BU.stat$LAN) + ifelse(BU.stat$LAN%in%c(1,2,3),0,-3))
ggplot(BU.stat,aes(x=bLen,group=SID,color=BU,linetype=LAN)) + geom_density() + 
  xlim(c(0,5000)) + facet_wrap(~KDM+BU,ncol=3,scales="free")
```

```{r}
ggplot(BU.stat,aes(x=cLen,group=SID,color=BU,linetype=rep)) + geom_density() + 
  xlim(c(0,5000)) + facet_wrap(~KDM+BU,ncol=3,scales="free")

```


```{r}
BU.ABN$SAM <- substr(BU.ABN$SID,1,1)
BU.ABN$LAN <- substr(BU.ABN$SID,2,2)
BU.ABN$KDM <- ifelse(BU.ABN$LAN%in%c(1,2,3),"BAC","FUG")
BU.ABN$BU <- factor(BU.ABN$BU,levels=c("16S","16S&23S","23S","18S","18S&28S","28S"))
ggplot(BU.ABN,aes(x=cLen,group=SID,color=BU,linetype=LAN)) + geom_density() + 
  xlim(c(0,5000)) + facet_wrap(~KDM+BU,ncol=3,scales="free")

```


```{r}
t.sp.df <- t.stat
t.sp.df$SAM <- substr(t.sp.df$SID,1,1)
t.sp.df$LAN <- substr(t.sp.df$SID,2,2)
t.sp.df$KDM <- ifelse(t.sp.df$LAN%in%c(1,2,3),"BAC","FUG")
t.sp.df$unit <- factor(t.sp.df$unit,levels=c("16S","23S","18S","28S"))
ggplot(t.sp.df,aes(x=cLen,group=SID,color=unit,linetype=LAN)) + geom_density() + 
  xlim(c(0,5000)) + facet_wrap(~KDM+unit,ncol=2,scales="free")

```

```{r, eval=FALSE}
t.ABN <- BU.comb
t.ABN$SAM <- substr(t.ABN$SID,1,1)
t.ABN$LAN <- substr(t.ABN$SID,2,2)
t.ABN$KDM <- ifelse(t.ABN$LAN%in%c(1,2,3),"BAC","FUG")
t.ABN$unit <- factor(t.ABN$unit,levels=c("16S","23S","18S","28S"))
ggplot(t.ABN,aes(x=cLen,group=SID,color=unit,linetype=LAN)) + geom_density() + 
  xlim(c(0,5000)) + facet_wrap(~KDM+unit,ncol=2,scales="free")

#Peaks of prediction for 23S and 28S in Fungi are slightly different. Others are similar.
```





#stat blast annotation of clips fasta to silva database
```{bash}
# batch beta
metabbq smk -j -npk SAM/{{U,O,S,M,Z}{1,2,3},{S,O,M,Y}{4,5,6}}/stat/summary.BI.megahit.clip.slv.stat.beads

for i in {{U,O,S,M,Z}{1,2,3},{S,O,M,Y}{4,5,6}};do 
  awk -v n=$i '{print n"\t"$0}' SAM/$i/stat/summary.BI.megahit.clip.slv.stat.clips;
done > ../../Results/AUG20/STAT/megahit.clip.slv.stat.clips

#
for i in {{U,O,S,M,Z}{1,2,3},{S,O,M,Y}{4,5,6}};do 
  awk -v n=$i '{print n"\t"$0}' SAM/$i/stat/summary.BI.megahit.clip.slv.stat.beads;
done > ../../Results/AUG20/STAT/megahit.clip.slv.stat.beads

```


```{r}
RDFile <- "../../Results/AUG20/STAT/clipSLV.RData"
if(file.exists(RDFile)){
  if(md5sum(RDFile)=="c0733f17cbc0fa33947d76f96c185dec"){ 
    load(RDFile)
  }else{
    warning("md5sum check mismatch! U better check again.")
  }
}else{
  comm.names <- c("saccver", "pident", "length", "mismatch", "gapopen", "qstart", 
          "qend", "sstart", "send", "evalue", "bitscore", "qlen", "name", "taxid", "rank", "path")
  clip.slv.stat.clip <- read.table("../../Results/AUG20/STAT/megahit.clip.slv.stat.clips",
    sep="\t",as.is = T,quote = "",comment.char="",
    col.names=c("SID","BNo","unit", "maxIdent", "delta", "range", "cLv","cName", "qaccver",
    paste0(rep(c("SSU","LSU"),each=length(comm.names)),".",rep(comm.names,2))))
  
  clip.slv.stat.bead <-read.table("../../Results/AUG20/STAT/megahit.clip.slv.stat.beads",
    sep="\t",as.is = T,quote = "",comment.char="",
    col.names = c("SID","BB", "clips", "clv", "cName","path"))
  
  save(clip.slv.stat.clip,clip.slv.stat.bead,file=RDFile)
  
  # md5sum(RDFile)
  # save the md5sum value to line 559.

}
#
clip.slv.sc <- clip.slv.stat.clip[,c(1:8,11:16,19:24,27:32,35:40)]
csdf <- merge(metadata,clip.slv.sc,by="SID")
csdf$BB <- substr(csdf$BNo,1,10)
csdf$SAM<- substr(csdf$SID,1,1)

pFun <- function(x){
  res <- rep(NA,8)
  if(is.na(x)|x==""){
    return(res)
  }else{
    y <- unlist(strsplit(x,";"))
    res[1:length(y)] <- y
    return(res)
  }
}
the.names <- c("k","p","c","o","f","g","s","t")
SSU.path <- as.data.frame(t(sapply(clip.slv.stat.clip$SSU.path,pFun,USE.NAMES=F)))
colnames(SSU.path) <- the.names
SSU.path.df <- cbind(csdf[,1:6],SSU.path)
LSU.path <- as.data.frame(t(sapply(clip.slv.stat.clip$LSU.path,pFun,USE.NAMES=F)))
colnames(LSU.path) <- the.names
LSU.path.df <- cbind(csdf[,1:6],LSU.path)


# pick trust anno
trust.SSU.id <- which(csdf$unit%in%c("SSU","Either")|(csdf$unit=="BOTH"&csdf$SSU.pident>=csdf$LSU.pident))
trust.SSU.df <- cbind(csdf[trust.SSU.id,c(1:7,37,38,13:24)],SSU.path[trust.SSU.id,])
colnames(trust.SSU.df) <- sub("SSU.","",colnames(trust.SSU.df))

trust.LSU.id <- which(csdf$unit=="LSU"|(csdf$unit=="BOTH"&csdf$SSU.pident<csdf$LSU.pident))
trust.LSU.df <- cbind(csdf[trust.LSU.id,c(1:7,37,38,25:36)],LSU.path[trust.LSU.id,])
colnames(trust.LSU.df) <- sub("LSU.","",colnames(trust.LSU.df))

trust.csdf <- rbind(trust.SSU.df,trust.LSU.df)
```

Clip lengths:
```{r}
p <- ggplot(csdf,aes(x=SSU.qlen,color=lane))
p + geom_density() + facet_wrap(~kindom+SAM,ncol=3,scale="free")
```


Unit detection:
```{r}
csdf$unit <- factor(csdf$unit,levels=c("Both","SSU","LSU","Either","UNK","NONE"))
p <- ggplot(csdf,aes(x=SID,fill=unit))
p + geom_bar(position="stack")
p + geom_bar(position="fill")

```

Length dist in each unit:
```{r}
p <- ggplot(csdf%>%filter(unit%in%c("Both","SSU","LSU","NONE")))
p + geom_density(aes(x=range,color=unit,linetype=lane)) + facet_wrap(~kindom+SAM,ncol=3,scale="free")
p + geom_density(aes(x=delta,color=unit,linetype=lane)) + facet_wrap(~kindom+SAM,ncol=3,scale="free")

```


Length dist of 'Both' unit:
```{r}
p <- ggplot(csdf%>%filter(unit=="Both"),aes(x=range,fill=lane))
p + geom_histogram(position="dodge") + facet_wrap(~kindom+SAM,ncol=3,scale="free")
```

```{r}
# csdf$SSU.rank2 <- ifelse(is.na(csdf$SSU.taxid),"missing",ifelse(csdf$SSU.name%in%c("uncultured bacterium",""),"UNK",csdf$SSU.rank))
# csdf$LSU.rank2 <- ifelse(is.na(csdf$LSU.taxid),"missing",ifelse(csdf$LSU.name%in%c("uncultured bacterium",""),"UNK",csdf$LSU.rank))
s.rank.sc <- ddply(csdf,colnames(csdf)[c(1:5,24)],summarise,count=length(BNo))
l.rank.sc <- ddply(csdf,colnames(csdf)[c(1:5,36)],summarise,count=length(BNo))
colnames(s.rank.sc)[6] <- "rank"; colnames(l.rank.sc)[6] <- "rank"
rank.sc <- rbind(cbind(group="SSU",s.rank.sc),cbind(group="LSU",l.rank.sc))
rank.sc$rank <- factor(rank.sc$rank,levels=c("missing","UNK","no rank","kingdom","phylum","class","order","family","genus","species","subspecies","varietas","forma"))
ggplot(rank.sc,aes(x=group,y=count,fill=rank)) +
  geom_bar(stat="identity",position="stack") + 
  theme(axis.text.x = element_text(angle = -90, hjust = -1, vjust = .5)) +
  facet_grid(.~SID,scale="free",space="free")
ggplot(rank.sc,aes(x=group,y=count,fill=rank)) + geom_bar(stat="identity",position="fill") +
  facet_grid(.~SID,scale="free",space="free")

```


length distribution of each 'unit':
```{r}
ggplot(csdf,aes(x=delta,color=unit,linetype=lane)) +geom_density() +
  facet_wrap(~kindom+SAM,ncol=3,scale="free") + ggtitle("delta dist")
unit.pos.sc <- ddply(csdf%>%filter(delta>0),
                     colnames(csdf)[c(1:5,7)],summarise,count=length(BNo))
ggplot(unit.pos.sc,aes(x=SID,y=count,fill=unit)) + geom_bar(stat="identity",position="stack") +
  ggtitle("unit dist with delta >0")
```

```{r}
csdf$shortLen <- ifelse(csdf$SSU.length<csdf$LSU.length,csdf$SSU.length,csdf$LSU.length)
csdf$minIdent <- ifelse(csdf$SSU.pident<csdf$LSU.pident,csdf$SSU.pident,csdf$LSU.pident)

csdf$dlt <- ifelse(
  csdf$SSU.qstart<csdf$LSU.qstart,
  ifelse(csdf$SSU.qend<csdf$LSU.qend,csdf$LSU.qstart-csdf$SSU.qend,csdf$LSU.qstart-csdf$LSU.qend),
  ifelse(csdf$LSU.qend<csdf$SSU.qend,csdf$SSU.qstart-csdf$LSU.qend,csdf$SSU.qstart-csdf$SSU.qend)
)
ggplot(csdf,aes(x=dlt/shortLen,y=minIdent)) + 
  #stat_density2d(geom="raster",h=c(100,100),contour=F) + 
  stat_density_2d(aes(fill = stat(nlevel)), geom = "polygon") + 
  scale_fill_gradientn(colours=rev(brewer.pal(11,"Spectral"))) +
  facet_wrap(~kindom+SAM,ncol=3,scale="free") + 
  ggtitle("Proportion of delta and range over short aligned length")
```

```{r}
ggplot(csdf,aes(x=delta,y=range)) + 
  stat_density_2d(aes(fill = stat(nlevel)), geom = "polygon") + 
  scale_fill_gradientn(colours=rev(brewer.pal(11,"Spectral"))) +
  facet_wrap(~kindom+SAM,ncol=3,scale="free") + 
  ggtitle("Distribution of delta and range")
```

```{r}
ggplot(csdf%>%filter(SSU.qlen>999),aes(x=delta,y=range)) + 
  stat_density_2d(aes(fill = stat(nlevel)), geom = "polygon") + 
  scale_fill_gradientn(colours=rev(brewer.pal(11,"Spectral"))) +
  facet_wrap(~kindom+SAM,ncol=3,scale="free") + 
  ggtitle("Distribution of delta and range with clips > 1kb")
```


compare of length
```{r, warning=FALSE}
ggplot(csdf,aes(x=SSU.length,y=LSU.length)) + 
  #stat_density2d(geom="raster",h=c(100,100),contour=F) + 
  stat_density_2d(aes(fill = stat(nlevel)), geom = "polygon") + 
  scale_fill_gradientn(colours=rev(brewer.pal(11,"Spectral"))) +
  facet_wrap(~kindom+SAM,ncol=3,scale="free")
```

```{r, warning=FALSE}
ggplot(csdf%>%filter(unit=="BOTH"),aes(x=SSU.pident,y=LSU.pident)) + 
  #stat_density2d(geom="raster",h=c(100,100),contour=F) + 
  stat_density_2d(aes(fill = stat(nlevel)), geom = "polygon") + 
  scale_fill_gradientn(colours=rev(brewer.pal(11,"Spectral"))) +
  facet_wrap(~kindom+SAM,ncol=3,scale="free") + 
  scale_x_continuous(breaks=seq(90,100,2),limits=c(90,100)) +
  scale_y_continuous(breaks=seq(90,100,2),limits=c(90,100))
```

```{r}
csidf <- csdf
csidf$SSU.pident[which(is.na(csidf$SSU.pident))] <- 89
csidf$LSU.pident[which(is.na(csidf$LSU.pident))] <- 89

ggplot(csidf,aes(x=SSU.pident,y=LSU.pident)) + 
  #stat_density2d(geom="raster",h=c(100,100),contour=F) + 
  stat_density_2d(aes(fill = stat(nlevel)), geom = "polygon") + 
  scale_fill_gradientn(colours=rev(brewer.pal(11,"Spectral"))) +
  facet_wrap(~kindom+SAM,ncol=3,scale="free") + 
  scale_x_continuous(breaks=seq(90,100,2),limits=c(88,100)) +
  scale_y_continuous(breaks=seq(90,100,2),limits=c(88,100)) +
  ggtitle("Comaprison of identity of SSU and LSU")
```

```{r}
ggplot(csdf%>%filter(SSU.qlen>999),aes(x=SSU.pident,y=LSU.pident)) + 
  #stat_density2d(geom="raster",h=c(100,100),contour=F) + 
  stat_density_2d(aes(fill = stat(nlevel)), geom = "polygon") + 
  scale_fill_gradientn(colours=rev(brewer.pal(11,"Spectral"))) +
  facet_wrap(~kindom+SAM,ncol=3,scale="free") + 
  scale_x_continuous(breaks=seq(90,100,2),limits=c(90,100)) +
  scale_y_continuous(breaks=seq(90,100,2),limits=c(90,100)) +
  ggtitle("Comaprison of identity of SSU and LSU with clips > 1kb")
```

```{r}
ggplot(csdf%>%filter(SSU.qlen<=999),aes(x=SSU.pident,y=LSU.pident)) + 
  #stat_density2d(geom="raster",h=c(100,100),contour=F) + 
  stat_density_2d(aes(fill = stat(nlevel)), geom = "polygon") + 
  scale_fill_gradientn(colours=rev(brewer.pal(11,"Spectral"))) +
  facet_wrap(~kindom+SAM,ncol=3,scale="free") + 
  scale_x_continuous(breaks=seq(90,100,2),limits=c(90,100)) +
  scale_y_continuous(breaks=seq(90,100,2),limits=c(90,100)) +
  ggtitle("Comaprison of identity of SSU and LSU with clips < 1kb")
```

```{r}
csidf$SSU.length[which(is.na(csidf$SSU.length))] <- 0
csidf$LSU.length[which(is.na(csidf$LSU.length))] <- 0

ggplot(csidf,aes(x=SSU.length,y=LSU.length)) + 
  #stat_density2d(geom="raster",h=c(100,100),contour=F) + 
  stat_density_2d(aes(fill = stat(nlevel)), geom = "polygon") + 
  scale_fill_gradientn(colours=rev(brewer.pal(11,"Spectral"))) +
  facet_wrap(~kindom+SAM,ncol=3,scale="free") + 
  scale_x_continuous(breaks=seq(0,3000,200),limits=c(0,2000)) +
  scale_y_continuous(breaks=seq(0,3000,200),limits=c(0,2000)) +
  ggtitle("Comaprison of length of SSU and LSU")
```
From above figure, we can choose alignment with length > 500 as valid hits.

Try 3d density plot:
```{r}
library(plotly)
kd <- csdf%>%filter(SID=="Z1")
kd$SSU.ident <- round(kd$SSU.pident,1)
kd$LSU.ident <- round(kd$LSU.pident,1)
kd$clip.len <- round(kd$SSU.qlen/10,0)*10
kds <- ddply(kd,colnames(kd)[c(2:5,39:41)],summarise,count=length(SID))

ggplot(kds,aes(x=count)) + geom_density() +scale_x_log10() + annotation_logticks(sides="b")

color11 <- RColorBrewer::brewer.pal("Spectral",n=11)

fig <- plot_ly(
  kds%>%filter(count>5), x = ~SSU.ident, y = ~LSU.ident, z = ~clip.len,
  size=~log10(count), sizes = c(1, 50),
  marker=list(symbol = 'circle', sizemode = 'diameter',
              color = ~log10(count), colorbar=list(title='Colorbar'), colorscale='Rainbow',
    reversescale =F,
              opacity = 0.5, line = list(width=0))
               )
fig <- fig %>% add_markers()
fig <- fig %>% layout(scene = list(xaxis = list(title = 'SSU identity'),
                                   yaxis = list(title = 'LSU identity'),
                                   zaxis = list(title = 'clip length'))
)

htmlwidgets::saveWidget(as_widget(fig), "index.html")
```

if both units' identity very high, how similar their annotation are:
```{r}
kc <- csdf%>%filter(SID=="Z1")
kc$SSU.ident <- round(kc$SSU.pident,1)
kc$LSU.ident <- round(kc$LSU.pident,1)

kcs <- ddply(kc,colnames(kc)[c(2:5,11,39:40)],summarise,count=length(SID))

ggplot(kcs,aes(x=count)) + geom_density() +scale_x_log10() + annotation_logticks(sides="b")

color11 <- RColorBrewer::brewer.pal("Spectral",n=11)

fig <- plot_ly(
  kcs%>%filter(count>2), x = ~SSU.ident, y = ~LSU.ident, z = ~cLv,
  size=~log(count), sizes = c(0, 30), color = ~log(count),
  marker=list(symbol = 'circle', sizemode = 'diameter',
              colorbar=list(title='Colorbar'), colorscale='Rainbow',
    reversescale =F,
              opacity = 0.3, line = list(width=0))
               )
fig <- fig %>% add_markers()
fig <- fig %>% layout(scene = list(xaxis = list(title = 'SSU identity'),
                                   yaxis = list(title = 'LSU identity'),
                                   zaxis = list(title = 'cLV'))
)

htmlwidgets::saveWidget(as_widget(fig), "index.html")
```

```{r}
iidf <- csdf
iidf$ii <- round(csdf$SSU.pident*csdf$LSU.pident,0)/100

ggplot(iidf,aes(x=ii,y=cLv),aes(x=ii,y=cLv)) + 
  stat_density_2d(aes(fill = stat(nlevel)), geom = "polygon") + 
  scale_fill_gradientn(colours=rev(brewer.pal(11,"Spectral"))) +
  facet_wrap(~kindom+SAM,ncol=3) + 
  scale_x_continuous(breaks=seq(80,100,2),limits=c(80,100)) +
  scale_y_continuous(breaks=seq(-1,7,2)) +
  xlab("SSU.pident * LSU.pident") + ylab("cLv") + 
  ggtitle("Comaprison of identity^2 of and cLv")
```


################################################################################
# Bead scale:
################################################################################
  
distinguish detected units for each bead:  
```{r}
bsdf <- 
table(csdf$unit)
csdf.both <- csdf%>%filter(unitCheck=="both")
ggplot(csdf.both,aes(x=delta,color=lane)) + geom_density() + facet_wrap(~kindom+SAM,ncol=3,scale="free")
ggplot(csdf.both,aes(x=range,color=lane)) + geom_density() + facet_wrap(~kindom+SAM,ncol=3,scale="free")


```

```{r}
ggplot(csdf,aes(x=maxIdent,color=unit,linetype=lane)) + 
  geom_density() + facet_wrap(~kindom+SAM,ncol=3,scale="free")

```


```{r}
csdf$trustRank <- ifelse(csdf$SSU.pident>=csdf$LSU.pident,csdf$SSU.rank,csdf$LSU.rank)
csdf$trustRank[which(is.na(csdf$trustRank))] <- "UNK"
csdf$trustRank[which(csdf$trustRank=="")] <- "missing"
csdf$trustRank <- factor(csdf$trustRank,c("UNK","missing","no rank","kingdom","phylum","class","order","family","genus","species","subspecies","varietas","forma"))
tr.sc <- ddply(csdf,c(colnames(csdf)[c(1:5)],"trustRank"),summarise,count=length(BNo))
tr.sc$trustRank <- factor(tr.sc$trustRank,levels(csdf$trustRank))
#plot:
ggplot(tr.sc,aes(x=SID,y=count,fill=trustRank)) + geom_bar(stat="identity",position="stack")
ggplot(tr.sc,aes(x=SID,y=count,fill=trustRank)) + geom_bar(stat="identity",position="fill")

```

Identity:
```{r}
ggplot(csdf,aes(x=SSU.pident,color=lane)) + geom_density() + facet_wrap(~kindom+SAM,ncol=3,scale="free")
ggplot(csdf,aes(x=LSU.pident,color=lane)) + geom_density() + facet_wrap(~kindom+SAM,ncol=3,scale="free")
ggplot(csdf,aes(x=maxIdent,color=lane)) + geom_density() + facet_wrap(~kindom+SAM,ncol=3,scale="free")
```

Aligned length:
```{r}
csdf$maxLen <- ifelse(csdf$SSU.pident>=csdf$LSU.pident,csdf$SSU.length,csdf$LSU.length)

ggplot(csdf,aes(x=SSU.length,color=lane)) + geom_density() + facet_wrap(~kindom+SAM,ncol=3,scale="free")
ggplot(csdf,aes(x=LSU.length,color=lane)) + geom_density() + facet_wrap(~kindom+SAM,ncol=3,scale="free")
ggplot(csdf,aes(x=maxLen,color=lane)) + geom_density() + facet_wrap(~kindom+SAM,ncol=3,scale="free")
ggplot(csdf,aes(x=range,color=lane)) + geom_density() + facet_wrap(~kindom+SAM,ncol=3,scale="free")

```

**identity under each rank:**
```{r,warning=FALSE}
ggplot(csdf,aes(x=SSU.pident,color=SSU.rank2,linetype=lane)) + geom_density() +
  facet_wrap(~kindom+SAM,ncol=3,scale="free") + scale_x_continuous(breaks=seq(90,100,2))
ggplot(csdf,aes(x=LSU.pident,color=LSU.rank2,linetype=lane)) + geom_density() +
  facet_wrap(~kindom+SAM,ncol=3,scale="free") + scale_x_continuous(breaks=seq(90,100,2))
ggplot(csdf,aes(x=maxIdent,color=trustRank,linetype=lane)) + geom_density() +
  facet_wrap(~kindom+SAM,ncol=3,scale="free") + scale_x_continuous(breaks=seq(90,100,2))

```


**length under each rank:**
```{r,warning=FALSE}
ggplot(csdf,aes(x=SSU.length,color=SSU.rank2,linetype=lane)) + geom_density() +
  facet_wrap(~kindom+SAM,ncol=3,scale="free")
ggplot(csdf,aes(x=LSU.length,color=LSU.rank2,linetype=lane)) + geom_density() +
  facet_wrap(~kindom+SAM,ncol=3,scale="free")
ggplot(csdf,aes(x=maxLen,color=trustRank,linetype=lane)) + geom_density() +
  facet_wrap(~kindom+SAM,ncol=3,scale="free")

csdf$trustRank2 <- ifelse(csdf$trustRank%in%c("subspecies","varietas","forma"),"<species",as.character(csdf$trustRank))
csdf$trustRank2 <- factor(csdf$trustRank2,levels = c(levels(csdf$trustRank)[1:10],"<species"))
  
ggplot(csdf%>%filter(trustRank2!="<species"),aes(x=range,color=trustRank2,linetype=lane)) + geom_density() +
  facet_wrap(~kindom+SAM,ncol=3,scale="free")
```


```{r}
ggplot(csdf%>%filter(trustRank2!="<species"),aes(x=LSU.qlen,color=trustRank2,linetype=lane)) + geom_density() + xlab("clipLength") +
  facet_wrap(~kindom+SAM,ncol=3,scale="free")
```

```{r}
ggplot(csdf,aes(x=maxIdent,color=unit,linetype=rep)) + geom_density() + 
  facet_wrap(~kindom+SAM,ncol=3,scale="free") + xlim(c(95,100))
```

```{r}
ggplot(csdf,aes(x=range,color=unit,linetype=rep)) + geom_density() + 
  facet_wrap(~kindom+SAM,ncol=3,scale="free")
```


```{r}
csdf$delta0 <- ifelse(is.na(csdf$delta),0,csdf$delta)
ggplot(csdf,aes(x=delta0/range,color=unit,linetype=rep)) + geom_density() + 
  facet_wrap(~kindom+SAM,ncol=3,scale="free") + xlim(c(-1,1))
```

```{r}
ggplot(csdf,aes(x=delta0,color=unit,linetype=rep)) + geom_density() + 
  facet_wrap(~kindom+SAM,ncol=3,scale="free")
```

clips identity of SSU and LSU
```{r}

```

*View in BB scale*


```{r,warning=FALSE}
csbdf <- merge(metadata,clip.slv.stat.bead,by="SID")
csbdf$SAM <- substr(csbdf$SID,1,1)

ggplot(csbdf,aes(x=factor(clips),fill=factor(clv))) + geom_bar() + 
  facet_wrap(~kindom+SAM,ncol=3,scale="free")
ggplot(csbdf,aes(x=factor(clips),fill=factor(clv))) + geom_bar(position="fill") + 
  facet_wrap(~kindom+SAM,ncol=3,scale="free")
```



**taxonomies distribution**
```{r}
ggplot(SSU.path.df,aes(x=SID,fill=k)) + geom_bar(position="stack")
ggplot(LSU.path.df,aes(x=SID,fill=k)) + geom_bar(position="stack")
ggplot(SSU.path.df,aes(x=SID,fill=k)) + geom_bar(position="fill")
ggplot(LSU.path.df,aes(x=SID,fill=k)) + geom_bar(position="fill")

```

Trust tax distribution
```{r}
zymo.df <- trust.csdf%>%filter(SAM=="Z")
top10.zymo <- names(rev(sort(table(zymo.df$s)))[1:12])
zymo.df$Tax <- ifelse(zymo.df$s%in%top10.zymo,as.character(zymo.df$s),"Others")
ggplot(zymo.df,aes(x=SID,fill=Tax)) + geom_bar(position="fill") 
```

```{r}
mock.df <- trust.csdf%>%filter(SAM=="M")
top10.mock <- names(rev(sort(table(mock.df$s)))[1:12])
mock.df$Tax <- ifelse(mock.df$s%in%top10.mock,as.character(mock.df$s),"Others")
ggplot(mock.df,aes(x=SID,fill=Tax)) + geom_bar(position="fill") 

```

```{r}
yeast.df <- trust.csdf%>%filter(SAM=="Y")
top10.yeast <- names(rev(sort(table(yeast.df$s)))[1:12])
yeast.df$Tax <- ifelse(yeast.df$s%in%top10.yeast,as.character(yeast.df$s),"Others")
ggplot(yeast.df,aes(x=SID,fill=Tax)) + geom_bar(position="fill") 

```

```{r}
top.p <- rev(sort(table(c(as.character(SSU.path$p),as.character(LSU.path$p)))))[1:100]
SSU.path.df$tp <- factor(SSU.path.df$p,levels=names(top.p)[1:21])
LSU.path.df$tp <- factor(LSU.path.df$p,levels=names(top.p)[1:21])

ggplot(SSU.path.df,aes(x=SID,fill=tp)) + geom_bar(position="stack")
ggplot(LSU.path.df,aes(x=SID,fill=tp)) + geom_bar(position="stack")

```

identity > 99%
```{r}
table(csdf$SSU.pident>99)
table(csdf$LSU.pident>99)

```











#FIN.